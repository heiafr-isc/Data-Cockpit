name: New release

on:
  pull_request_review:
    types: [submitted]
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  update-versions:
    if: startsWith(github.event.pull_request.head.ref, 'develop') && github.event.review.state == 'approved'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v6
      with:
        ref: ${{ github.event.pull_request.head.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'

    - name: Getting parent version
      run: |
        VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
        # Save the modules to GitHub environment 
        echo "OLD_VERSION=${VERSION}" >> $GITHUB_ENV
        # Display version
        echo "PROJECT VERSION: ${VERSION}"

    - name: Determine overall change level
      run: |
        # Initialize highest level priority
        # patch=0, minor=1, major=2
        highest=-1
        
        # Extract Unreleased section
        unreleased=$(sed -n '/^## Unreleased/,/^## /p' CHANGELOG.md | sed '$d')
        
        # Check each line for semantic version tags
        while read -r line; do
          case "$line" in
              major:*) level=2 ;;
              minor:*) level=1 ;;
              patch:*) level=0 ;;
              *) continue ;;
          esac
      
          if (( level > highest )); then
              highest=$level
          fi
        done <<< "$unreleased"
        
        # Map level back to name
        if (( highest == 2 )); then
          CHANGE_TYPE="major"
        elif (( highest == 1 )); then
          CHANGE_TYPE="minor"
        elif (( highest == 0 )); then
          CHANGE_TYPE="patch"
        else
          CHANGE_TYPE=""
        fi
        
        # Save the modules to GitHub environment
        echo "CHANGE_TYPE=${CHANGE_TYPE}" >> $GITHUB_ENV
        # Display change type
        echo "CHANGE TYPE: ${CHANGE_TYPE}"

    - name: Determine new version number
      run: |
        CHANGE_TYPE="${{ env.CHANGE_TYPE }}"
        OLD_VERSION="${{ env.OLD_VERSION }}"
        
        if [[ ! "$OLD_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
          echo "Old version must be in format X.Y.Z"
          exit 1
        fi
        
        # Extract major, minor, patch
        MAJOR="${BASH_REMATCH[1]}"
        MINOR="${BASH_REMATCH[2]}"
        PATCH="${BASH_REMATCH[3]}"
        
        # Bump version according to semantic versioning
        case "$CHANGE_TYPE" in
          major)
            MAJOR=$((MAJOR + 1))
            MINOR=0
            PATCH=0
            ;;
          minor)
            MINOR=$((MINOR + 1))
            PATCH=0
            ;;
          patch)
            PATCH=$((PATCH + 1))
            ;;
          *)
            echo "Change type must be one of: major, minor, patch"
            exit 1
            ;;
        esac
        
        NEW_VERSION="$MAJOR.$MINOR.$PATCH"
        
        # Save the version number to GitHub environment
        echo "NEW_VERSION=${NEW_VERSION}" >> $GITHUB_ENV
        # Display new version number
        echo "NEW VERSION: ${NEW_VERSION}"

    - name: Update Parent POM Version
      run: |
        mvn versions:set -DnewVersion=${{ env.NEW_VERSION }} -DprocessAllModules=true -DgenerateBackupPoms=false

    - name: Update modules Version
      run: |
        MODULES=("tree" "database" "visualizer" "general_libraries" "experiments")
        echo "Modules to build: $MODULES"
        for MODULE in "${MODULES[@]}"; do
          echo "Updating module: $MODULE"
          mvn -f $MODULE/pom.xml build-helper:parse-version versions:set -DnewVersion=${{ env.NEW_VERSION }} -DprocessAllModules=true -DgenerateBackupPoms=false
        done

    - name: Update Parent Properties
      run: |
        mvn versions:update-properties

    - name: Update Child Modules
      run: |
        mvn -N versions:update-child-modules

    - name: Configure Git
      run: |
        git config --local user.name "github-actions[bot]"
        git config --local user.email "13170944+GuibertLo@users.noreply.github.com"
    - name: Commit & Push
      run: |
        if [[ -n "$(git status --porcelain)" ]]; then
          git add .
          git commit -m "github-actions[bot]: updating software versioning, automation of a post-merge into main"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}
        else
          echo "No changes to commit"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  release:
    needs: update-versions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v6
        with:
          ref: 'develop'
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Getting parent version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          # Save the modules to GitHub environment
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          # Display the extracted value
          echo "VERSION=${VERSION}"

      - name: Update Changelog
        id: update_changelog
        run: |
          VERSION="${{ env.VERSION }}"
          TODAY=$(date +"%Y.%m.%d")
          
          # Concatenate all unreleased versions into a release note
          sed -i "0,/^## Unreleased/{s/^## Unreleased/## $VERSION ($TODAY)/}" CHANGELOG.md
          
          # Extract the newest version's release note
          RELEASE_NOTE=$(cat CHANGELOG.md | sed -n '/^## /{n; :a; /^## /q; p; n; ba}')
          
          # Export the extracted changelog as an environment variable
          echo "RELEASE_NOTE<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTE" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Configure Git
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "13170944+GuibertLo@users.noreply.github.com"
          git switch develop

      - name: Commit & Push
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "github-actions[bot]: changelog changes because of new release, automation of a post-merge into main"
            git push origin HEAD:${{ github.event.pull_request.head.ref }}
          else
            echo "No changes to commit"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          target_commitish: ${{ github.event.pull_request.head.ref }}
          body: |
            ${{ env.RELEASE_NOTE }}
          tag_name: ${{ env.VERSION }}
          name: Release ${{ env.VERSION }}
          make_latest: true
          draft: false
          prerelease: false